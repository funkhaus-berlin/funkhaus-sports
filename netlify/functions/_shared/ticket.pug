doctype html
html(lang="en")
  head
    meta(charset="UTF-8")
    meta(name="viewport" content="width=device-width, initial-scale=1.0")
    title Court Booking Confirmation
    //- Simplified JSON-LD for Gmail calendar integration
    script(type="application/ld+json").
      {
        "@context": "http://schema.org",
        "@type": "EventReservation",
        "reservationId": "#{bookingId || ''}",
        "reservationStatus": "http://schema.org/Confirmed",
        "underName": {
          "@type": "Person",
          "name": "#{customer.name}"
        },
        "reservationFor": {
          "@type": "Event",
          "name": "Court Booking: #{booking.court}",
          "startDate": "#{calendarEvent && calendarEvent.startDate ? calendarEvent.startDate : ''}",
          "endDate": "#{calendarEvent && calendarEvent.endDate ? calendarEvent.endDate : ''}",
          "location": {
            "@type": "Place",
            "name": "#{booking.venue}"
          }
        }
      }
    style.
      /* Base styles */
      body {
        font-family: "GT-Eesti-Pro-Display-Regular", -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        line-height: 1.4;
        color: #222;
        background-color: #121212;
        margin: 0;
        padding: 0;
      }
      
      /* Container */
      .container {
        max-width: 600px;
        margin: 0 auto;
        background: #fff;
      }
      
      /* Header */
      .header {
        background-color: #000;
        padding: 24px 0;
        text-align: center;
      }
      .logo {
        height: 24px;
        width: auto;
      }
      
      /* Main content */
      .content {
        padding: 40px;
      }
      
      /* Booking details */
      .greeting {
        font-size: 15px;
        margin: 0 0 8px;
        color: #666;
        letter-spacing: 0.01em;
      }
      .booking-title {
        font-size: 26px;
        font-weight: 500;
        margin: 0 0 30px;
        color: #000;
        letter-spacing: -0.02em;
      }
      
      /* Featured date box - improved layout */
      .date-banner {
        display: flex;
        align-items: stretch;
        margin-bottom: 30px;
        background-color: #fff;
        border: 1px solid #e1e1e1;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      }
      .date-box {
        flex-shrink: 0;
        text-align: center;
        padding: 20px 10px;
        width: 90px;
        background-color: #000;
        color: #fff;
      }
      .date-day {
        font-size: 42px;
        font-weight: 600;
        line-height: 1;
        letter-spacing: -0.02em;
      }
      .date-month {
        text-transform: uppercase;
        font-size: 14px;
        letter-spacing: 0.05em;
        margin-top: 4px;
        font-weight: 500;
      }
      .date-year {
        font-size: 12px;
        opacity: 0.7;
        margin-top: 2px;
      }
      .date-details {
        flex-grow: 1;
        padding: 20px;
        display: flex;
        flex-direction: row;
        justify-content: center;
      }
      .time-display {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 8px;
        color: #000;
      }
      .location-display {
        font-size: 15px;
        color: #444;
        margin: 0 0 5px 0;
      }
      .address-line {
        font-size: 14px;
        color: #666;
        margin: 0 0 5px 0;
      }
      .price-display {
        font-size: 16px;
        margin: 10px 0 0 0;
        color: #000;
      }
      
      /* Calendar section - improved layout */
      .calendar-section {
        margin: 35px 0;
        padding: 30px;
        text-align: center;
        background-color: #f7f7f7;
        border-radius: 4px;
      }
      .calendar-heading {
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #555;
        margin: 0 0 20px;
        font-weight: 500;
      }
      .calendar-links {
        display: flex;
        justify-content: center;
        gap: 24px;
        margin: 0;
        padding: 0;
      }
      .calendar-links a {
        display: inline-block;
        color: #000;
        background-color: #fff;
        text-decoration: none;
        font-size: 13px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        padding: 10px 20px;
        border-radius: 3px;
        border: 1px solid #e1e1e1;
        transition: all 0.2s ease;
      }
      .calendar-links a:hover {
        background-color: #f0f0f0;
      }
      .calendar-note {
        font-size: 14px;
        color: #666;
        margin: 10px 0 0;
        font-style: italic;
      }
      
      /* Footer */
      .footer {
        margin-top: 40px;
        padding: 24px 0;
        text-align: center;
        font-size: 12px;
        color: #777;
        border-top: 1px solid #e1e1e1;
      }
      .footer a {
        color: #000;
        text-decoration: none;
        font-weight: 500;
      }

  body
    div.container
      div.header
        img.logo(src="https://funkhausevents.netlify.app/logo-light.svg" alt="Funkhaus")
      
      div.content
        p.greeting Hello #{customer.name},
        h1.booking-title Your booking is confirmed
        
        //- Featured date banner with key booking info
        div.date-banner
          //- Date box with day, month, year
          div.date-box
            if booking.date
              - var dateObj = new Date(booking.date)
              - var day = dateObj.getDate()
              - var month = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'][dateObj.getMonth()]
              - var year = dateObj.getFullYear()
              div.date-day #{day}
              div.date-month #{month}
              div.date-year #{year}
          
          div.date-details
            p.time-display #{booking.startTime} — #{booking.endTime}
            p.location-display
              strong #{booking.court}
              |  at #{booking.venue}
            
            //- Simplified address display
            if venue
              //- First try to fetch the address directly from the venue object
              - var addressParts = []
              
              //- Street address
              if venue.address && typeof venue.address === 'string'
                - addressParts.push(venue.address)
              else if venue.address && venue.address.street
                - addressParts.push(venue.address.street)
                
              //- City and postal code
              - var locationParts = []
              
              if venue.postalCode
                - locationParts.push(venue.postalCode)
              else if venue.address && venue.address.postalCode
                - locationParts.push(venue.address.postalCode)
                
              if venue.city
                - locationParts.push(venue.city)
              else if venue.address && venue.address.city
                - locationParts.push(venue.address.city)
                
              if locationParts.length > 0
                - addressParts.push(locationParts.join(' '))
                
              //- Country
              - var country = venue.country || (venue.address && venue.address.country ? venue.address.country : null)
              if country
                - addressParts.push(country)
              
              //- Display address if available
              if addressParts.length > 0
                p.address-line #{addressParts.join(', ')}
            
            p.price-display 
              strong €#{booking.price}
        
        //- Calendar section simplified
        div.calendar-section
          p.calendar-heading Add to your calendar
          
          //- Simple calendar links using calendarEvent data
          - try {
          -   var googleTitle = encodeURIComponent('Court Booking: ' + booking.court)
          -   var googleDetails = encodeURIComponent('Your booking at ' + booking.venue)
          -   var googleLocation = encodeURIComponent(booking.venue)
          
          -   if (calendarEvent && calendarEvent.googleStartDate && calendarEvent.googleEndDate) {
          -     var googleStartDate = calendarEvent.googleStartDate
          -     var googleEndDate = calendarEvent.googleEndDate
          
          -     var googleLink = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${googleTitle}&dates=${googleStartDate}/${googleEndDate}&details=${googleDetails}&location=${googleLocation}&sf=true&output=xml`
          -     var outlookLink = `https://outlook.office.com/calendar/0/deeplink/compose?subject=${googleTitle}&body=${googleDetails}&location=${googleLocation}`
          -   } else {
          -     // Create fallback dates
          -     var dateObj = new Date(booking.date)
          -     var startHour = parseInt(booking.startTime.split(':')[0])
          -     var startAmPm = booking.startTime.includes('PM') || booking.startTime.includes('pm')
          -     if (startAmPm && startHour < 12) startHour += 12
          -     var endHour = parseInt(booking.endTime.split(':')[0])
          -     var endAmPm = booking.endTime.includes('PM') || booking.endTime.includes('pm')
          -     if (endAmPm && endHour < 12) endHour += 12
          
          -     dateObj.setHours(startHour)
          -     var startDate = dateObj.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '')
          -     dateObj.setHours(endHour)
          -     var endDate = dateObj.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '')
          
          -     var googleLink = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${googleTitle}&dates=${startDate}/${endDate}&details=${googleDetails}&location=${googleLocation}&sf=true&output=xml`
          -     var outlookLink = `https://outlook.office.com/calendar/0/deeplink/compose?subject=${googleTitle}&body=${googleDetails}&location=${googleLocation}`
          -   }
          - } catch(e) {
          -   var googleLink = "#"
          -   var outlookLink = "#"
          - }
          
          div.calendar-links
            a(href=googleLink, target="_blank") 
              | Google Calendar
            a(href=outlookLink, target="_blank") 
              | Outlook
            a(href="#" download="court-booking.ics") 
              | Apple Calendar
      
      div.footer
        | Questions? Contact 
        if venue && venue.contactEmail
          a(href=`mailto:${venue.contactEmail}`) #{venue.contactEmail}
          if venue && venue.contactPhone
            |  or call #{venue.contactPhone}
        else
          a(href="mailto:booking@funkhaus-sports.com") booking@funkhaus-sports.com
